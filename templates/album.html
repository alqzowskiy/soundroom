{% extends "base.html" %}

{% block title %}Album Details - SoundRoom{% endblock %}

{% block extra_css %}
<style>
    .album-header {
        display: flex;
        align-items: flex-end;
        padding: 32px 0;
        margin-bottom: 24px;
    }

    /* Audio player styles */
    .preview-player {
        background-color: var(--spotify-dark-gray);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }

    .preview-info {
        flex: 1;
        min-width: 200px;
    }

    .preview-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .preview-subtitle {
        color: var(--spotify-light-gray);
        font-size: 14px;
    }

    .preview-controls {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .preview-play-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--spotify-green);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s, background-color 0.2s;
    }

    .preview-play-btn:hover {
        transform: scale(1.05);
        background-color: var(--spotify-dark-green);
    }

    .preview-progress {
        flex: 1;
        height: 4px;
        background-color: var(--spotify-gray);
        border-radius: 2px;
        position: relative;
        overflow: hidden;
    }

    .preview-progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: var(--spotify-green);
        width: 0;
        transition: width 0.1s linear;
    }

    .preview-time {
        font-size: 12px;
        color: var(--spotify-light-gray);
        min-width: 45px;
        text-align: center;
    }

    .settings-toggle {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        gap: 12px;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--spotify-gray);
        transition: .4s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked+.toggle-slider {
        background-color: var(--spotify-green);
    }

    input:checked+.toggle-slider:before {
        transform: translateX(24px);
    }

    .toggle-label {
        font-size: 14px;
        font-weight: 500;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .preview-player {
            flex-direction: column;
            align-items: stretch;
        }

        .preview-controls {
            width: 100%;
        }
    }

    .album-cover-large {
        width: 232px;
        height: 232px;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        margin-right: 24px;
        flex-shrink: 0;
    }

    .album-info {
        flex-grow: 1;
    }

    .album-title {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 8px;
        line-height: 1.2;
    }

    .album-artist {
        font-size: 18px;
        color: var(--spotify-light-gray);
        margin-bottom: 16px;
    }

    .album-meta {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: var(--spotify-light-gray);
    }

    .album-meta span:not(:last-child)::after {
        content: "•";
        margin: 0 8px;
    }

    .track-list {
        margin: 24px 0;
    }

    .track-row {
        display: grid;
        grid-template-columns: 48px 1fr 80px;
        align-items: center;
        padding: 8px 16px;
        border-radius: 4px;
    }

    .track-row:hover {
        background-color: var(--spotify-hover-gray);
    }

    .track-number {
        color: var(--spotify-light-gray);
        font-size: 16px;
        text-align: right;
        padding-right: 16px;
    }

    .track-title {
        font-weight: 500;
    }

    .track-duration {
        text-align: right;
        color: var(--spotify-light-gray);
    }

    .ratings-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    .rating-box {
        background-color: var(--spotify-dark-gray);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
    }

    .rating-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .rating-label {
        font-size: 14px;
        color: var(--spotify-light-gray);
    }

    .rating-form {
        background-color: var(--spotify-dark-gray);
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 32px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .form-label-text {
        font-weight: 500;
    }

    .form-label-value {
        color: var(--spotify-light-gray);
    }

    .comment-list {
        margin-top: 32px;
    }

    .comment-card {
        background-color: var(--spotify-dark-gray);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .comment-user {
        display: flex;
        align-items: center;
    }

    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
    }

    .comment-username {
        font-weight: 700;
    }

    .comment-date {
        font-size: 14px;
        color: var(--spotify-light-gray);
    }

    .comment-ratings {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .comment-rating {
        text-align: center;
    }

    .comment-rating-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--spotify-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin: 0 auto 4px;
    }

    .comment-rating-label {
        font-size: 12px;
        color: var(--spotify-light-gray);
    }

    .comment-text {
        line-height: 1.5;
    }

    /* Таблица рейтингов */
    .ratings-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        overflow: hidden;
        border-radius: 8px;
        margin-bottom: 32px;
    }

    .ratings-table th {
        background-color: var(--spotify-gray);
        color: var(--spotify-light-gray);
        text-align: left;
        padding: 16px;
        font-weight: 600;
        font-size: 14px;
    }

    .ratings-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--spotify-gray);
    }

    .ratings-table tbody tr {
        background-color: var(--spotify-dark-gray);
        transition: background-color 0.2s;
    }

    .ratings-table tbody tr:hover {
        background-color: var(--spotify-hover-gray);
    }

    .ratings-table .rating-cell {
        text-align: center;
        font-weight: 700;
    }

    .user-info {
        display: flex;
        align-items: center;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 12px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
    }

    .section-subtitle {
        color: var(--spotify-light-gray);
        font-size: 14px;
    }

    @media (max-width: 768px) {
        .album-header {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .album-cover-large {
            margin-right: 0;
            margin-bottom: 16px;
            width: 180px;
            height: 180px;
        }

        .ratings-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .ratings-table {
            display: block;
            overflow-x: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Album Header -->
<div class="album-header">
    <img id="album-cover" src="https://i.scdn.co/image/ab67616d0000b273c628cc25720a9648b1219e5b" alt="Album Cover"
        class="album-cover-large">

    <div class="album-info">
        <h1 id="album-name" class="album-title">Loading...</h1>
        <div id="album-artist" class="album-artist"></div>
        <div class="album-meta">
            <span id="album-year"></span>
            <span id="album-tracks-count"></span>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="tab-bar">
    <div class="tab active" data-tab="overview">Overview</div>
    <div class="tab" data-tab="room-ratings">Room Ratings</div>
    <div class="tab" data-tab="rate">Rate Album</div>
    <div class="tab" data-tab="reviews">Reviews</div>
</div>

<!-- Overview Tab -->
<div id="overview-tab" class="tab-content">
    <!-- Rating Summary -->
    <div class="section-header">
        <h2 class="section-title">Room Ratings</h2>
        <div class="section-subtitle">Ratings from this room only</div>
    </div>

    <div class="ratings-grid">
        <div class="rating-box">
            <div id="room-sound-avg" class="rating-value">-</div>
            <div class="rating-label">Sound</div>
        </div>
        <div class="rating-box">
            <div id="room-lyrics-avg" class="rating-value">-</div>
            <div class="rating-label">Lyrics</div>
        </div>
        <div class="rating-box">
            <div id="room-vibe-avg" class="rating-value">-</div>
            <div class="rating-label">Vibe</div>
        </div>
        <div class="rating-box">
            <div id="room-overall-avg" class="rating-value">-</div>
            <div class="rating-label">Overall</div>
        </div>
    </div>

    <!-- Tracklist -->
    <h2 class="section-title">Tracklist</h2>
    <div id="album-tracks" class="track-list">
        <div class="spinner"></div>
    </div>
</div>

<!-- Room Ratings Tab -->
<div id="room-ratings-tab" class="tab-content hidden">
    <div class="section-header">
        <h2 class="section-title">Room Ratings Table</h2>
        <div class="section-subtitle">See how everyone rated this album</div>
    </div>

    <div id="room-ratings-table-container">
        <div class="spinner"></div>
    </div>
</div>

<!-- Rate Tab -->
<div id="rate-tab" class="tab-content hidden">
    <div class="rating-form">
        <h2 class="text-xl font-bold mb-6">Rate This Album</h2>

        <form id="rating-form">
            <div class="form-group">
                <div class="form-label">
                    <span class="form-label-text">Sound (1-10)</span>
                    <span id="sound-value" class="form-label-value">5</span>
                </div>
                <input type="range" id="sound-rating" min="1" max="10" value="5" class="rating-slider"
                    oninput="updateSliderValue('sound-value', this.value)">
            </div>

            <div class="form-group">
                <div class="form-label">
                    <span class="form-label-text">Lyrics (1-10)</span>
                    <span id="lyrics-value" class="form-label-value">5</span>
                </div>
                <input type="range" id="lyrics-rating" min="1" max="10" value="5" class="rating-slider"
                    oninput="updateSliderValue('lyrics-value', this.value)">
            </div>

            <div class="form-group">
                <div class="form-label">
                    <span class="form-label-text">Vibe (1-10)</span>
                    <span id="vibe-value" class="form-label-value">5</span>
                </div>
                <input type="range" id="vibe-rating" min="1" max="10" value="5" class="rating-slider"
                    oninput="updateSliderValue('vibe-value', this.value)">
            </div>

            <div class="form-group">
                <div class="form-label">
                    <span class="form-label-text">Overall (1-10)</span>
                    <span id="overall-value" class="form-label-value">5</span>
                </div>
                <input type="range" id="overall-rating" min="1" max="10" value="5" class="rating-slider"
                    oninput="updateSliderValue('overall-value', this.value)">
            </div>

            <div class="form-group">
                <label for="rating-comment" class="block font-medium mb-2">Your Review (Optional)</label>
                <textarea id="rating-comment" class="spotify-input" rows="4"
                    placeholder="Share your thoughts on this album..."></textarea>
            </div>

            <button type="submit" class="btn-spotify w-full">Submit Rating</button>
        </form>
    </div>
</div>

<!-- Reviews Tab -->
<div id="reviews-tab" class="tab-content hidden">
    <h2 class="section-title">Reviews & Ratings</h2>
    <div id="ratings-list" class="comment-list">
        <div class="spinner"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const roomId = "{{ room_id }}";
    const albumId = "{{ album_id }}";
    let albumData = null;
    let userRating = null;
    let roomMembers = [];
    let roomRatings = [];

    // Single initialization point
    document.addEventListener('DOMContentLoaded', function () {
        // Set a flag to prevent double initialization
        if (window.appInitialized) return;
        window.appInitialized = true;

        // Fix tab layout first
        fixTabLayout();

        // Initialize data
        loadAlbumData();
        loadRoomRatings();
        checkUserRating();
        loadRoomMembersAndRatings();
        loadRatings();
    });

    // Fix tab layout
    function fixTabLayout() {
        const tabBar = document.querySelector('.tab-bar');

        if (!tabBar) return;

        // Get existing active tab
        const activeTabName = tabBar.querySelector('.tab.active')?.getAttribute('data-tab') || 'overview';

        // Create new container
        const newTabBar = document.createElement('div');
        newTabBar.className = 'new-tab-bar';
        newTabBar.style.cssText = 'display: flex; width: 100%; margin: 0; padding: 0; background-color: #121212;';

        // Tab data for album page
        const tabData = [
            { name: 'overview', icon: 'fa-music', text: 'Overview' },
            { name: 'room-ratings', icon: 'fa-chart-simple', text: 'Room Ratings' },
            { name: 'rate', icon: 'fa-heart', text: 'Rate Album' },
            { name: 'reviews', icon: 'fa-comment', text: 'Reviews' }
        ];

        // Create tabs and store references
        window.tabReferences = {};

        tabData.forEach(tab => {
            const tabElement = document.createElement('div');
            tabElement.className = `new-tab ${tab.name === activeTabName ? 'active' : ''}`;
            tabElement.setAttribute('data-tab', tab.name);
            tabElement.style.cssText = `
          flex: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 16px 0;
          color: ${tab.name === activeTabName ? 'white' : '#b3b3b3'};
          background-color: ${tab.name === activeTabName ? '#1DB954' : '#121212'};
          cursor: pointer;
          font-weight: 600;
          gap: 8px;
          transition: background-color 0.2s;
        `;

            tabElement.innerHTML = `<i class="fa-solid ${tab.icon}"></i> ${tab.text}`;

            // Add click event
            tabElement.addEventListener('click', function () {
                // Get selected tab content
                const tabName = this.getAttribute('data-tab');

                // Update active states
                document.querySelectorAll('.new-tab').forEach(t => {
                    t.classList.remove('active');
                    t.style.backgroundColor = '#121212';
                    t.style.color = '#b3b3b3';
                });
                this.classList.add('active');
                this.style.backgroundColor = '#1DB954';
                this.style.color = 'white';

                // Show selected tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tabName + '-tab')?.classList.remove('hidden');

                // Refresh data if needed
                if (tabName === 'reviews') {
                    loadRatings();
                }
            });

            // Store reference to the new tab element
            window.tabReferences[tab.name] = tabElement;

            newTabBar.appendChild(tabElement);
        });

        // Replace old tab bar with new one
        tabBar.parentNode.replaceChild(newTabBar, tabBar);

        // Add necessary styles
        const style = document.createElement('style');
        style.textContent = `
        .new-tab-bar {
          display: flex !important;
          width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
        }
        .new-tab {
          flex: 1 !important;
          margin: 0 !important;
          padding: 16px 0 !important;
          text-align: center !important;
        }
        .new-tab.active {
          background-color: #1DB954 !important;
          color: white !important;
        }
    `;
        document.head.appendChild(style);

        // Create a global function to switch tabs programmatically
        window.switchToTab = function (tabName) {
            const tab = window.tabReferences[tabName];
            if (tab) {
                tab.click();
                return true;
            }
            return false;
        };

        // Override querySelector to handle old tab selectors
        const originalQuerySelector = document.querySelector;
        document.querySelector = function (selector) {
            if (selector && typeof selector === 'string' && selector.includes('.tab[data-tab=')) {
                // Extract the tab name from the selector
                const tabNameMatch = selector.match(/data-tab="([^"]+)"/);
                if (tabNameMatch && tabNameMatch[1]) {
                    const tabName = tabNameMatch[1];
                    // Return a fake element that has a click method
                    return {
                        click: function () {
                            window.switchToTab(tabName);
                        }
                    };
                }
            }
            // Otherwise use the original function
            return originalQuerySelector.call(document, selector);
        };
    }

    // Load album data
    function loadAlbumData() {
        db.collection('albums').doc(albumId).get()
            .then(doc => {
                if (doc.exists) {
                    albumData = doc.data();

                    // Update UI
                    document.getElementById('album-cover').src = albumData.coverUrl || 'https://i.scdn.co/image/ab67616d0000b273c628cc25720a9648b1219e5b';
                    document.getElementById('album-name').textContent = albumData.name || 'Unknown Album';
                    document.getElementById('album-artist').textContent = albumData.artist || 'Unknown Artist';

                    // Album info
                    if (albumData.releaseDate) {
                        const year = new Date(albumData.releaseDate).getFullYear();
                        document.getElementById('album-year').textContent = year;
                    }

                    if (albumData.tracks && albumData.tracks.length > 0) {
                        document.getElementById('album-tracks-count').textContent = `${albumData.tracks.length} songs`;
                        loadTracks(albumData.tracks);
                    } else {
                        document.getElementById('album-tracks').innerHTML = '<p class="text-center py-4 text-spotify-light-gray">No track information available</p>';
                    }
                } else {
                    alert('Album not found!');
                    window.location.href = `/room/${roomId}`;
                }
            })
            .catch(error => {
                console.error("Error loading album: ", error);
                alert('Error loading album: ' + error.message);
            });
    }

    // Load tracks
    function loadTracks(tracks) {
        const tracksList = document.getElementById('album-tracks');
        tracksList.innerHTML = '';

        if (!tracks || tracks.length === 0) {
            tracksList.innerHTML = '<p class="text-center py-4 text-spotify-light-gray">No track information available</p>';
            return;
        }

        tracks.forEach((track, index) => {
            const trackItem = document.createElement('div');
            trackItem.className = 'track-row';

            // Format duration from milliseconds to mm:ss
            const minutes = Math.floor(track.duration_ms / 60000);
            const seconds = ((track.duration_ms % 60000) / 1000).toFixed(0);
            const duration = minutes + ":" + (seconds < 10 ? '0' : '') + seconds;

            trackItem.innerHTML = `
            <div class="track-number">${track.track_number || index + 1}</div>
            <div class="track-title">${track.name}</div>
            <div class="track-duration">${duration}</div>
        `;

            tracksList.appendChild(trackItem);
        });
    }

    // Load room ratings
    function loadRoomRatings() {
        db.collection('ratings')
            .where('albumId', '==', albumId)
            .where('roomId', '==', roomId)
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    // No ratings yet
                    document.getElementById('room-sound-avg').textContent = '-';
                    document.getElementById('room-lyrics-avg').textContent = '-';
                    document.getElementById('room-vibe-avg').textContent = '-';
                    document.getElementById('room-overall-avg').textContent = '-';
                    return;
                }

                // Calculate average ratings for this room
                let totalSound = 0;
                let totalLyrics = 0;
                let totalVibe = 0;
                let totalOverall = 0;
                let soundCount = 0;
                let lyricsCount = 0;
                let vibeCount = 0;
                let overallCount = 0;

                // Track unique users
                const uniqueUserIds = new Set();

                snapshot.forEach(doc => {
                    const ratingData = doc.data();

                    // Skip duplicate ratings from the same user
                    if (uniqueUserIds.has(ratingData.userId)) return;
                    uniqueUserIds.add(ratingData.userId);

                    if (ratingData.ratings) {
                        if (ratingData.ratings.sound) {
                            totalSound += parseInt(ratingData.ratings.sound);
                            soundCount++;
                        }
                        if (ratingData.ratings.lyrics) {
                            totalLyrics += parseInt(ratingData.ratings.lyrics);
                            lyricsCount++;
                        }
                        if (ratingData.ratings.vibe) {
                            totalVibe += parseInt(ratingData.ratings.vibe);
                            vibeCount++;
                        }
                        if (ratingData.ratings.overall) {
                            totalOverall += parseInt(ratingData.ratings.overall);
                            overallCount++;
                        }
                    }
                });

                const averageSound = soundCount > 0 ? (totalSound / soundCount).toFixed(1) : '-';
                const averageLyrics = lyricsCount > 0 ? (totalLyrics / lyricsCount).toFixed(1) : '-';
                const averageVibe = vibeCount > 0 ? (totalVibe / vibeCount).toFixed(1) : '-';
                const averageOverall = overallCount > 0 ? (totalOverall / overallCount).toFixed(1) : '-';

                // Update UI
                document.getElementById('room-sound-avg').textContent = averageSound;
                document.getElementById('room-lyrics-avg').textContent = averageLyrics;
                document.getElementById('room-vibe-avg').textContent = averageVibe;
                document.getElementById('room-overall-avg').textContent = averageOverall;
            })
            .catch(error => {
                console.error("Error loading room ratings: ", error);
            });
    }

    // Check if user already rated this album
    function checkUserRating() {
        const userId = "spotify:{{ session.get('spotify_user', {}).get('id', '') }}";

        db.collection('ratings')
            .where('albumId', '==', albumId)
            .where('roomId', '==', roomId)
            .where('userId', '==', userId)
            .get()
            .then(snapshot => {
                if (!snapshot.empty) {
                    userRating = snapshot.docs[0].data();

                    // Fill form with existing rating
                    document.getElementById('sound-rating').value = userRating.ratings.sound;
                    document.getElementById('lyrics-rating').value = userRating.ratings.lyrics;
                    document.getElementById('vibe-rating').value = userRating.ratings.vibe;
                    document.getElementById('overall-rating').value = userRating.ratings.overall;
                    document.getElementById('rating-comment').value = userRating.comment || '';

                    // Update labels
                    updateSliderValue('sound-value', userRating.ratings.sound);
                    updateSliderValue('lyrics-value', userRating.ratings.lyrics);
                    updateSliderValue('vibe-value', userRating.ratings.vibe);
                    updateSliderValue('overall-value', userRating.ratings.overall);
                }
            })
            .catch(error => {
                console.error("Error checking user rating:", error);
            });
    }

    // Load room members and their ratings
    function loadRoomMembersAndRatings() {
        // Get room data to get members
        db.collection('rooms').doc(roomId).get()
            .then(doc => {
                if (doc.exists) {
                    const roomData = doc.data();
                    if (roomData.members && roomData.members.length > 0) {
                        roomMembers = roomData.members;

                        // Get all ratings for this album in this room
                        return db.collection('ratings')
                            .where('albumId', '==', albumId)
                            .where('roomId', '==', roomId)
                            .get();
                    }
                }
                throw new Error('Room not found or no members');
            })
            .then(snapshot => {
                // Store all ratings
                roomRatings = [];

                // Track unique users to prevent duplicates
                const uniqueUserIds = new Set();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Skip duplicate ratings from the same user
                    if (!uniqueUserIds.has(data.userId)) {
                        uniqueUserIds.add(data.userId);
                        roomRatings.push(data);
                    }
                });

                // Create the ratings table
                createRatingsTable();
            })
            .catch(error => {
                console.error("Error loading room members and ratings:", error);
                document.getElementById('room-ratings-table-container').innerHTML =
                    '<p class="text-center py-8 text-spotify-light-gray">Error loading ratings table</p>';
            });
    }

    // Load ratings for reviews tab
    function loadRatings() {
        db.collection('ratings')
            .where('albumId', '==', albumId)
            .where('roomId', '==', roomId)
            .orderBy('createdAt', 'desc')
            .get()
            .then(snapshot => {
                const ratingsList = document.getElementById('ratings-list');
                ratingsList.innerHTML = '';

                if (snapshot.empty) {
                    ratingsList.innerHTML = '<p class="text-center py-8 text-spotify-light-gray">No reviews yet. Be the first to review this album!</p>';
                    return;
                }

                // Track unique users to prevent duplicates
                const uniqueUserIds = new Set();

                // Process each rating
                snapshot.docs.forEach(doc => {
                    const ratingData = doc.data();

                    // Skip duplicate ratings from the same user
                    if (uniqueUserIds.has(ratingData.userId)) return;
                    uniqueUserIds.add(ratingData.userId);

                    // Get user ID from rating
                    const spotifyId = ratingData.userId.startsWith('spotify:')
                        ? ratingData.userId.split(':')[1]
                        : ratingData.userId;

                    // Create review card
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'comment-card';

                    // Format date if available
                    let dateDisplay = 'Recently';
                    if (ratingData.createdAt) {
                        const ratingDate = ratingData.createdAt.toDate();
                        dateDisplay = ratingDate.toLocaleDateString() + ' ' + ratingDate.toLocaleTimeString();
                    }

                    // Get user name from session if it's the current user
                    let userName = 'Spotify User';
                    let userImage = `<div class="comment-avatar bg-spotify-green flex items-center justify-center text-white font-bold">?</div>`;

                    if (spotifyId === "{{ session.get('spotify_user', {}).get('id', '') }}") {
                        userName = "{{ session.get('spotify_user', {}).get('display_name', 'You') }}";

                        // Check if user has a profile image
                        {% if session.get('spotify_user', {}).get('images') and session['spotify_user']['images'] | length > 0 %}
                        userImage = `<img src="{{ session['spotify_user']['images'][0]['url'] }}" alt="Your profile" class="comment-avatar">`;
                        {% else %}
                        userImage = `<div class="comment-avatar bg-spotify-green flex items-center justify-center text-white font-bold">${userName.charAt(0)}</div>`;
                        {% endif %}
                    }

                    reviewCard.innerHTML = `
                    <div class="comment-header">
                        <div class="comment-user">
                            ${userImage}
                            <div>
                                <div class="comment-username">${userName}</div>
                                <div class="comment-date">${dateDisplay}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comment-ratings">
                        <div class="comment-rating">
                            <div class="comment-rating-circle">${ratingData.ratings.sound}</div>
                            <div class="comment-rating-label">Sound</div>
                        </div>
                        <div class="comment-rating">
                            <div class="comment-rating-circle">${ratingData.ratings.lyrics}</div>
                            <div class="comment-rating-label">Lyrics</div>
                        </div>
                        <div class="comment-rating">
                            <div class="comment-rating-circle">${ratingData.ratings.vibe}</div>
                            <div class="comment-rating-label">Vibe</div>
                        </div>
                        <div class="comment-rating">
                            <div class="comment-rating-circle">${ratingData.ratings.overall}</div>
                            <div class="comment-rating-label">Overall</div>
                        </div>
                    </div>
                    
                    ${ratingData.comment ? `<div class="comment-text">${ratingData.comment}</div>` : ''}
                `;

                    ratingsList.appendChild(reviewCard);
                });
            })
            .catch(error => {
                console.error("Error loading ratings: ", error);
                const ratingsList = document.getElementById('ratings-list');
                ratingsList.innerHTML = '<p class="text-center py-8 text-red-500">Error loading reviews</p>';
            });
    }

    // Create the ratings table
    function createRatingsTable() {
        const container = document.getElementById('room-ratings-table-container');

        if (roomRatings.length === 0) {
            container.innerHTML = '<p class="text-center py-8 text-spotify-light-gray">No ratings yet for this album in this room</p>';
            return;
        }

        // Create the table
        const table = document.createElement('table');
        table.className = 'ratings-table';

        // Create table header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `
        <th>User</th>
        <th class="text-center">Sound</th>
        <th class="text-center">Lyrics</th>
        <th class="text-center">Vibe</th>
        <th class="text-center">Overall</th>
        <th>Comment</th>
    `;
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Create table body
        const tbody = document.createElement('tbody');

        // Process each rating
        roomRatings.forEach(rating => {
            const row = document.createElement('tr');

            // Get user ID from rating
            const spotifyId = rating.userId && rating.userId.startsWith('spotify:')
                ? rating.userId.split(':')[1]
                : rating.userId;

            // Get user name - if current user, use session data
            let userName = 'Spotify User';
            let userAvatar = `<div class="user-avatar bg-spotify-green flex items-center justify-center text-white font-bold">?</div>`;

            if (spotifyId === "{{ session.get('spotify_user', {}).get('id', '') }}") {
                userName = "{{ session.get('spotify_user', {}).get('display_name', 'You') }}";

                // Check if user has a profile image
                {% if session.get('spotify_user', {}).get('images') and session['spotify_user']['images'] | length > 0 %}
                userAvatar = `<img src="{{ session['spotify_user']['images'][0]['url'] }}" alt="Your profile" class="user-avatar">`;
                {% else %}
                userAvatar = `<div class="user-avatar bg-spotify-green flex items-center justify-center text-white font-bold">${userName.charAt(0)}</div>`;
                {% endif %}
            }

            // Create user cell
            const userCell = document.createElement('td');
            userCell.innerHTML = `
            <div class="user-info">
                ${userAvatar}
                <div>${userName}</div>
            </div>
        `;

            // Safely get rating values
            const soundVal = rating.ratings && rating.ratings.sound ? rating.ratings.sound : '-';
            const lyricsVal = rating.ratings && rating.ratings.lyrics ? rating.ratings.lyrics : '-';
            const vibeVal = rating.ratings && rating.ratings.vibe ? rating.ratings.vibe : '-';
            const overallVal = rating.ratings && rating.ratings.overall ? rating.ratings.overall : '-';

            // Create rating cells
            const soundCell = document.createElement('td');
            soundCell.className = 'rating-cell';
            soundCell.textContent = soundVal;

            const lyricsCell = document.createElement('td');
            lyricsCell.className = 'rating-cell';
            lyricsCell.textContent = lyricsVal;

            const vibeCell = document.createElement('td');
            vibeCell.className = 'rating-cell';
            vibeCell.textContent = vibeVal;

            const overallCell = document.createElement('td');
            overallCell.className = 'rating-cell';
            overallCell.textContent = overallVal;

            // Create comment cell
            const commentCell = document.createElement('td');
            commentCell.textContent = rating.comment ?
                (rating.comment.length > 50 ? rating.comment.substring(0, 50) + '...' : rating.comment) :
                '-';

            // Add all cells to the row
            row.appendChild(userCell);
            row.appendChild(soundCell);
            row.appendChild(lyricsCell);
            row.appendChild(vibeCell);
            row.appendChild(overallCell);
            row.appendChild(commentCell);

            // Add row to table body
            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.innerHTML = '';
        container.appendChild(table);
    }

    // Submit rating - attach to form
    document.addEventListener('DOMContentLoaded', function () {
        const ratingForm = document.getElementById('rating-form');
        if (ratingForm) {
            ratingForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const soundRating = parseInt(document.getElementById('sound-rating').value);
                const lyricsRating = parseInt(document.getElementById('lyrics-rating').value);
                const vibeRating = parseInt(document.getElementById('vibe-rating').value);
                const overallRating = parseInt(document.getElementById('overall-rating').value);
                const comment = document.getElementById('rating-comment').value;

                const userId = "spotify:{{ session.get('spotify_user', {}).get('id', '') }}";

                // Show loading state
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = `<div class="spinner w-5 h-5 mx-auto"></div>`;
                submitButton.disabled = true;

                // Rating data
                const ratingData = {
                    albumId: albumId,
                    roomId: roomId,
                    userId: userId,
                    ratings: {
                        sound: soundRating,
                        lyrics: lyricsRating,
                        vibe: vibeRating,
                        overall: overallRating
                    },
                    comment: comment
                };

                // Check if user already rated this album
                if (userRating) {
                    // Update existing rating
                    db.collection('ratings')
                        .where('albumId', '==', albumId)
                        .where('roomId', '==', roomId)
                        .where('userId', '==', userId)
                        .get()
                        .then(snapshot => {
                            if (!snapshot.empty) {
                                const doc = snapshot.docs[0];
                                ratingData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

                                doc.ref.update(ratingData)
                                    .then(() => {
                                        // Reset button
                                        submitButton.innerHTML = originalText;
                                        submitButton.disabled = false;

                                        // Show success message
                                        alert('Your rating has been updated!');

                                        // Update UI
                                        loadRatings();
                                        loadRoomRatings();
                                        loadRoomMembersAndRatings();

                                        // Switch to room ratings tab
                                        window.switchToTab('room-ratings');
                                    })
                                    .catch(error => {
                                        // Reset button
                                        submitButton.innerHTML = originalText;
                                        submitButton.disabled = false;

                                        console.error("Error updating rating: ", error);
                                        alert('Error updating rating: ' + error.message);
                                    });
                            } else {
                                createNewRating(ratingData, submitButton, originalText);
                            }
                        })
                        .catch(error => {
                            // Reset button
                            submitButton.innerHTML = originalText;
                            submitButton.disabled = false;

                            console.error("Error checking existing rating: ", error);
                            alert('Error submitting rating: ' + error.message);
                        });
                } else {
                    createNewRating(ratingData, submitButton, originalText);
                }
            });
        }
    });

    // Create a new rating
    function createNewRating(ratingData, submitButton, originalText) {
        ratingData.createdAt = firebase.firestore.FieldValue.serverTimestamp();

        db.collection('ratings').add(ratingData)
            .then(() => {
                // Reset button
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;

                // Show success message
                alert('Your rating has been submitted!');

                // Update variables and UI
                userRating = ratingData;
                loadRatings();
                loadRoomRatings();
                loadRoomMembersAndRatings();

                // Switch to room ratings tab
                window.switchToTab('room-ratings');
            })
            .catch(error => {
                // Reset button
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;

                console.error("Error submitting rating: ", error);
                alert('Error submitting rating: ' + error.message);
            });
    }
    // Initialize the tab system once the DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        initializeTabs();
    });

    // Main function to initialize our tab system
    function initializeTabs() {
        const tabBar = document.querySelector('.tab-bar');
        if (!tabBar) return;

        // Determine which page we're on
        const isAlbumPage = window.location.pathname.includes('/album/') ||
            document.getElementById('overview-tab') !== null;

        // Get currently active tab
        const activeTabName = tabBar.querySelector('.tab.active')?.getAttribute('data-tab') ||
            (isAlbumPage ? 'overview' : 'albums');

        // Configure tabs based on page type
        const tabConfig = isAlbumPage ?
            // Album page tabs
            [
                { name: 'overview', icon: 'fa-music', text: 'Overview' },
                { name: 'room-ratings', icon: 'fa-chart-simple', text: 'Room Ratings' },
                { name: 'rate', icon: 'fa-heart', text: 'Rate Album' },
                { name: 'reviews', icon: 'fa-comment', text: 'Reviews' }
            ] :
            // Room page tabs
            [
                { name: 'albums', icon: 'fa-circle-play', text: 'Albums' },
                { name: 'add-album', icon: 'fa-plus', text: 'Add Album' },
                { name: 'members', icon: 'fa-user-group', text: 'Members' },
                { name: 'ratings', icon: 'fa-star', text: 'Ratings' }
            ];

        // Create the new tab container
        const spotifyTabs = document.createElement('div');
        spotifyTabs.className = 'spotify-tabs';
        spotifyTabs.style.display = 'flex';
        spotifyTabs.style.width = '100%';
        spotifyTabs.style.backgroundColor = '#121212';
        spotifyTabs.style.marginBottom = '24px';
        spotifyTabs.style.borderRadius = '4px';
        spotifyTabs.style.overflow = 'hidden';

        // Create and add each tab
        window.tabReferences = {};

        tabConfig.forEach(tab => {
            const tabElement = document.createElement('div');
            tabElement.className = `spotify-tab ${tab.name === activeTabName ? 'active' : ''}`;
            tabElement.setAttribute('data-tab', tab.name);

            tabElement.innerHTML = `<i class="fa-solid ${tab.icon}"></i> <span>${tab.text}</span>`;

            // Add click event
            tabElement.addEventListener('click', function () {
                // Update active states
                document.querySelectorAll('.spotify-tab').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');

                // Show selected tab content
                const tabName = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tabName + '-tab')?.classList.remove('hidden');

                // Refresh data if needed (for album reviews)
                if (tabName === 'reviews' && typeof loadRatings === 'function') {
                    loadRatings();
                }
            });

            // Store reference
            window.tabReferences[tab.name] = tabElement;
            spotifyTabs.appendChild(tabElement);
        });

        // Replace the old tab bar
        tabBar.parentNode.replaceChild(spotifyTabs, tabBar);

        // Add helper function for programmatic tab switching
        window.switchToTab = function (tabName) {
            const tab = window.tabReferences[tabName];
            if (tab) {
                tab.click();
                return true;
            }
            return false;
        };

        // Fix for old code that might try to use the old tab system
        if (typeof document.querySelector_original === 'undefined') {
            document.querySelector_original = document.querySelector;
            document.querySelector = function (selector) {
                if (selector && typeof selector === 'string' && selector.includes('.tab[data-tab=')) {
                    // Extract the tab name from the selector
                    const tabNameMatch = selector.match(/data-tab="([^"]+)"/);
                    if (tabNameMatch && tabNameMatch[1]) {
                        const tabName = tabNameMatch[1];
                        // Return a proxy object with click method
                        return {
                            click: function () {
                                window.switchToTab(tabName);
                            }
                        };
                    }
                }
                // Otherwise use the original function
                return document.querySelector_original.call(document, selector);
            };
        }

        // Set flag to prevent duplicate initialization
        window.tabsInitialized = true;
    }

    // Add the necessary CSS
    const tabStyle = document.createElement('style');
    tabStyle.textContent = `
    .spotify-tabs {
        display: flex;
        width: 100%;
        margin-bottom: 24px;
        border-radius: 4px;
        overflow: hidden;
        background-color: #121212;
    }
    
    .spotify-tab {
        flex: 1;
        padding: 16px 0;
        color: #b3b3b3;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        gap: 8px;
    }
    
    .spotify-tab:hover {
        color: #ffffff;
    }
    
    .spotify-tab.active {
        background-color: #1DB954;
        color: #ffffff;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
        .spotify-tabs {
            position: sticky;
            top: 60px;
            z-index: 10;
            margin-bottom: 16px;
        }
        
        .spotify-tab {
            padding: 12px 0;
            font-size: 13px;
        }
        
        .spotify-tab i {
            font-size: 16px;
        }
    }
    
    /* For very small screens */
    @media (max-width: 380px) {
        .spotify-tab span {
            display: none;
        }
        
        .spotify-tab i {
            font-size: 18px;
        }
    }
`;
    // Add this code at the end of both room.html and album.html script sections
    document.addEventListener('DOMContentLoaded', function () {
        // Apply direct style fixes to tabs
        const style = document.createElement('style');
        style.innerHTML = `
        /* Remove any existing tab styles */
        .tab-bar, .new-tab-bar, .spotify-tabs {
            background-color: #121212 !important;
            display: flex !important;
            width: 100% !important;
            margin-bottom: 24px !important;
            border-radius: 4px !important;
            overflow: hidden !important;
        }
        
        /* Force consistent tab styles */
        .tab, .new-tab, .spotify-tab {
            flex: 1 !important;
            padding: 14px 0 !important;
            color: #b3b3b3 !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: background-color 0.2s, color 0.2s !important;
            gap: 8px !important;
            background-color: transparent !important;
        }
        
        /* Active tab styles */
        .tab.active, .new-tab.active, .spotify-tab.active, 
        .tab[data-state="active"], .new-tab[data-state="active"], .spotify-tab[data-state="active"] {
            background-color: #1DB954 !important;
            color: #ffffff !important;
        }
        
        /* Hover styles */
        .tab:hover, .new-tab:hover, .spotify-tab:hover {
            color: #ffffff !important;
        }
    `;
        document.head.appendChild(style);

        // Safety check - ensure all tabs have correct event listeners
        setTimeout(function () {
            const tabs = document.querySelectorAll('.tab, .new-tab, .spotify-tab');
            tabs.forEach(tab => {
                // Remove existing click listeners (can't do directly, so create a clone)
                const newTab = tab.cloneNode(true);
                tab.parentNode.replaceChild(newTab, tab);

                // Add fresh click listener
                newTab.addEventListener('click', function () {
                    // Get all tabs in container and remove active class
                    const allTabs = this.parentNode.querySelectorAll('.tab, .new-tab, .spotify-tab');
                    allTabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('data-state', '');
                    });

                    // Make this tab active
                    this.classList.add('active');
                    this.setAttribute('data-state', 'active');

                    // Show correct content
                    const tabName = this.getAttribute('data-tab');
                    if (tabName) {
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        const tabContent = document.getElementById(tabName + '-tab');
                        if (tabContent) {
                            tabContent.classList.remove('hidden');
                        }
                    }
                });
            });
        }, 100);
    });
    /**
 * SoundRoom Tab Replacement
 * This code completely replaces the existing tabs with a new implementation
 */
    document.addEventListener('DOMContentLoaded', function () {
        // Run after a slight delay to ensure DOM is fully loaded and manipulated by other scripts
        setTimeout(function () {
            // First, find all tab containers by various selectors that might exist
            const tabContainers = document.querySelectorAll('.tab-bar, .new-tab-bar, .tab-container, .spotify-tabs');

            if (tabContainers.length === 0) return;

            tabContainers.forEach(container => {
                // Determine which page we're on to set appropriate tabs
                const isAlbumPage = window.location.pathname.includes('/album/') ||
                    document.getElementById('overview-tab') !== null;

                // Find which tab is currently active
                const activeTab = container.querySelector('.active, [data-state="active"]');
                const currentActiveTabName = activeTab ?
                    activeTab.getAttribute('data-tab') :
                    (isAlbumPage ? 'overview' : 'albums');

                // Define tabs based on page type
                const tabDefinitions = isAlbumPage ?
                    [
                        { name: 'overview', icon: 'fa-music', text: 'Overview' },
                        { name: 'room-ratings', icon: 'fa-chart-simple', text: 'Room Ratings' },
                        { name: 'rate', icon: 'fa-heart', text: 'Rate Album' },
                        { name: 'reviews', icon: 'fa-comment', text: 'Reviews' }
                    ] :
                    [
                        { name: 'albums', icon: 'fa-circle-play', text: 'Albums' },
                        { name: 'add-album', icon: 'fa-plus', text: 'Add Album' },
                        { name: 'members', icon: 'fa-user-group', text: 'Members' },
                        { name: 'ratings', icon: 'fa-star', text: 'Ratings' }
                    ];

                // Create completely new container with unique class name
                const newContainer = document.createElement('div');
                newContainer.className = 'soundroom-custom-tabs-v1';
                newContainer.setAttribute('data-original-container', container.className);

                // Add tabs to new container
                tabDefinitions.forEach(tab => {
                    const tabElement = document.createElement('div');
                    tabElement.className = 'soundroom-custom-tab-v1';
                    if (tab.name === currentActiveTabName) {
                        tabElement.className += ' soundroom-custom-tab-active-v1';
                    }
                    tabElement.setAttribute('data-tab', tab.name);

                    tabElement.innerHTML = `<i class="fa-solid ${tab.icon}"></i> <span>${tab.text}</span>`;

                    // Add click handler
                    tabElement.addEventListener('click', function (e) {
                        // Prevent any other handlers from firing
                        e.stopPropagation();

                        // Update active state visually
                        document.querySelectorAll('.soundroom-custom-tab-v1').forEach(t => {
                            t.classList.remove('soundroom-custom-tab-active-v1');
                        });
                        this.classList.add('soundroom-custom-tab-active-v1');

                        // Show correct content
                        const tabName = this.getAttribute('data-tab');
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        const tabContent = document.getElementById(tabName + '-tab');
                        if (tabContent) {
                            tabContent.classList.remove('hidden');
                        }

                        // Special handling for reviews tab to refresh data
                        if (tabName === 'reviews' && typeof loadRatings === 'function') {
                            loadRatings();
                        }
                    });

                    newContainer.appendChild(tabElement);
                });

                // Replace the original container with our new one
                container.parentNode.replaceChild(newContainer, container);
            });

            // Add our guaranteed-priority styles
            const customStyle = document.createElement('style');
            customStyle.innerHTML = `
            .soundroom-custom-tabs-v1 {
                display: flex !important;
                width: 100% !important;
                margin-bottom: 24px !important;
                border-radius: 4px !important;
                background-color: #121212 !important;
                overflow: hidden !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
            }
            
            .soundroom-custom-tab-v1 {
                flex: 1 !important;
                padding: 16px 0 !important;
                color: #b3b3b3 !important;
                font-weight: 600 !important;
                font-size: 14px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                gap: 8px !important;
                background-color: transparent !important;
                border: none !important;
                outline: none !important;
                text-align: center !important;
            }
            
            .soundroom-custom-tab-v1:hover {
                color: #ffffff !important;
                background-color: rgba(255,255,255,0.1) !important;
            }
            
            .soundroom-custom-tab-active-v1 {
                background-color: #1DB954 !important;
                color: #ffffff !important;
            }
            
            .soundroom-custom-tab-active-v1:hover {
                background-color: #1DB954 !important;
            }
            
            .soundroom-custom-tab-v1 i {
                font-size: 16px !important;
            }
            
            @media (max-width: 768px) {
                .soundroom-custom-tabs-v1 {
                    position: sticky !important;
                    top: 60px !important;
                    z-index: 10 !important;
                    margin-bottom: 16px !important;
                }
                
                .soundroom-custom-tab-v1 {
                    padding: 12px 0 !important;
                    font-size: 13px !important;
                }
            }
            
            @media (max-width: 480px) {
                .soundroom-custom-tab-v1 span {
                    display: none !important;
                }
                
                .soundroom-custom-tab-v1 i {
                    font-size: 18px !important;
                }
            }
        `;
            document.head.appendChild(customStyle);

            // Intercept any attempts to programmatically switch tabs
            if (!window.originalSwitchToTab) {
                window.originalSwitchToTab = window.switchToTab;
                window.switchToTab = function (tabName) {
                    const tab = document.querySelector(`.soundroom-custom-tab-v1[data-tab="${tabName}"]`);
                    if (tab) {
                        tab.click();
                        return true;
                    }
                    return false;
                };
            }
        }, 300); // Slight delay to ensure other scripts have run
    });
    document.head.appendChild(tabStyle);
</script>
{% endblock %}